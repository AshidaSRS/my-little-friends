# auto completion for the p4 (Perforce) command.
# by torstein.k.johansen@gmail.com

function get_branches()
{
    if [ ! -r $HOME/.p4-branches ]; then
        p4 branches | cut -d' ' -f2 > $HOME/.p4-branches
    fi

    echo $(cat $HOME/.p4-branches)
}

_p4_commands()
{
    local cur=${COMP_WORDS[COMP_CWORD]}
    local prev=${COMP_WORDS[COMP_CWORD-1]}

    commands="add admin annotate branch branches change changes changelist changelists client clients counter counters delete depot depots describe diff diff2 dirs edit filelog files fix fixes flush fstat group groups have help info integrate integrated job jobs jobspec label labels labelsync lock logger login logout monitor obliterate opened passwd print protect rename reopen resolve resolved revert review reviews set submit sync tag tickets triggers typemap unlock user users verify workspace workspaces where ..."

    # default completions is the list of commands
    completions=$commands

    case "$prev" in
        integrate)
            completions="-b -s"
            ;;
        -s)
            completions="@"
            ;;
        -b)
            completions=$(get_branches)
            ;;
    esac
    
    COMPREPLY=( $(compgen -W "$completions" -- $cur) )
}

complete -o default  -F _p4_commands p4

